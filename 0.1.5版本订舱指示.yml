app:
  description: æµ·è¿è®¢èˆ±ç³»ç»Ÿ
  icon: ğŸš¢
  icon_background: "#E6F4FF"
  mode: advanced-chat
  name: æµ·è¿è®¢èˆ±ç³»ç»Ÿ
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: openai/gpt-4
kind: app
version: 0.1.5
workflow:
  conversation_variables:
  - description: POL
    id: pol
    name: POL
    selector:
    - conversation
    - POL
    value: ''
    value_type: string
  - description: POD
    id: pod
    name: POD
    selector:
    - conversation
    - POD
    value: ''
    value_type: string
  # å…¶ä»–å˜é‡å®šä¹‰...
  environment_variables:
  - key: SMTP_SERVER
    value: smtp.example.com
  - key: SMTP_PORT 
    value: '587'
  features:
    file_upload:
      enabled: true
  graph:
    edges:
    - source: start
      target: user_input
    - source: user_input
      target: intent_check
    - source: intent_check
      target: param_extractor
    - source: param_extractor
      target: missing_check
    - source: missing_check
      target: missing_handler
      condition: '{{#param_extractor.missing_fields#}}'
    - source: missing_check
      target: order_processor
      condition: '{{^param_extractor.missing_fields#}}'
    - source: order_processor
      target: doc_generator
    - source: doc_generator
      target: final_response
    - source: missing_handler
      target: user_input
    nodes:
      - id: start
        type: start
        data:
          variables: []

      - id: user_input
        type: question-input
        data:
          answer: "è¯·è¾“å…¥è®¢èˆ±ä¿¡æ¯ï¼ˆç¤ºä¾‹ï¼‰ï¼š\nPOL:ä¸Šæµ· POD:æ´›æ‰çŸ¶ ETD:2024-05-20\né›†è£…ç®±ç±»å‹:40HQ æ‰¿è¿äºº:MAERSK\nèˆ¹åèˆªæ¬¡:MSC1234 æŠ¬å¤´:ABCå…¬å¸ è®¢èˆ±ä»£ç†:XYZç‰©æµ"

      - id: intent_check
        type: llm
        data:
          model:
            name: gpt-4
            provider: openai
          prompt_template:
            - role: system
              text: |
                è¯†åˆ«æ˜¯å¦ä¸ºæœ‰æ•ˆè®¢èˆ±è¯·æ±‚ï¼Œå“åº”æ ¼å¼ï¼š
                {"is_valid": true/false}

      - id: param_extractor
        type: code
        data:
          code: |
            import re
            required_fields = ["POL","POD","ETD","ContainerType","Carrier","VesselVoy","Title","BookingAgent"]
            
            patterns = {
                "POL": r"POL[:ï¼š]?\s*([^\s]+)",
                "POD": r"POD[:ï¼š]?\s*([^\s]+)",
                "ETD": r"ETD[:ï¼š]?\s*(\d{4}-\d{2}-\d{2})",
                "ContainerType": r"é›†è£…ç®±ç±»å‹[:ï¼š]?\s*([^\s]+)",
                "Carrier": r"æ‰¿è¿äºº[:ï¼š]?\s*([^\s]+)",
                "VesselVoy": r"èˆ¹åèˆªæ¬¡[:ï¼š]?\s*([^\s]+)",
                "Title": r"æŠ¬å¤´[:ï¼š]?\s*([^\s]+)",
                "BookingAgent": r"è®¢èˆ±ä»£ç†[:ï¼š]?\s*([^\s]+)"
            }
            
            extracted = {}
            missing = []
            for field, pattern in patterns.items():
                match = re.search(pattern, "{{#user_input.message#}}", re.IGNORECASE)
                extracted[field] = match.group(1) if match else None
                if not extracted[field]:
                    missing.append(field)
            
            output = {
                "extracted_data": extracted,
                "missing_fields": missing
            }
          outputs:
            extracted_data: object
            missing_fields: array

      - id: missing_check
        type: if-else
        data:
          cases:
            - case_id: 'true'
              conditions:
                - variable: param_extractor.missing_fields
                  operator: not_empty

      - id: missing_handler
        type: llm
        data:
          model:
            name: gpt-4
            provider: openai
          prompt_template:
            - role: system
              text: |
                è¯·ç”¨ä¸­æ–‡è¦æ±‚ç”¨æˆ·è¡¥å…¨ï¼š{{#param_extractor.missing_fields#}}

      - id: order_processor
        type: code
        data:
          code: |
            import random
            order_number = "A" + str(random.randint(1000, 9999)).zfill(4)
            output = {
                "order_number": order_number,
                "POL": "{{#param_extractor.extracted_data.POL#}}",
                "POD": "{{#param_extractor.extracted_data.POD#}}",
                # å…¶ä»–å­—æ®µ...
            }

      - id: doc_generator
        type: code
        data:
          code: |
            from reportlab.pdfgen import canvas
            # PDFç”Ÿæˆä»£ç ï¼ˆåŒä¹‹å‰ç‰ˆæœ¬ï¼‰
            output = {"pdf_path": "/path/to/file.pdf"}

      - id: final_response
        type: answer
        data:
          answer: |
            è®¢å•å·ï¼š{{#order_processor.order_number#}}
            ä¸‹è½½ï¼š{{#doc_generator.pdf_path#}}
